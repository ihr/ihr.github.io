<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<title>Chatting Through JActor</title>
	<meta name="description" content="" />

	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link rel="alternate" type="application/rss+xml" href="http://ingini.org/rss/">
	<link rel="shortcut icon" href="../../../../favicon.ico">
	<link rel="prefetch" href="http://ingini.org">

    <link rel="stylesheet" type="text/css" href="../../../../assets/css/prettify.css?v=b196cc4aea" />
	<link rel="stylesheet" type="text/css" href="../../../../assets/css/theme.min.css?v=b196cc4aea" />
	<link href='http://fonts.googleapis.com/css?family=Domine:700|Open+Sans:400,600|Source+Code+Pro:500' rel='stylesheet' type='text/css'>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<link rel="canonical" href="http://ingini.org/2012/11/11/chatting-through-jactor/" />
    
    <meta property="og:site_name" content="Ingini" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Chatting Through JActor" />
    <meta property="og:description" content="Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not..." />
    <meta property="og:url" content="http://ingini.org/2012/11/11/chatting-through-jactor/" />
    <meta property="article:published_time" content="2012-11-11T13:13:00.000Z" />
    <meta property="article:modified_time" content="2014-05-28T14:00:13.223Z" />
    <meta property="article:tag" content="Java" />
    <meta property="article:tag" content="Actor Model" />
    <meta property="article:tag" content="Concurrency" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Chatting Through JActor" />
    <meta name="twitter:description" content="Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not..." />
    <meta name="twitter:url" content="http://ingini.org/2012/11/11/chatting-through-jactor/" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Ingini",
    "author": {
        "@type": "Person",
        "name": "Ivan Hristov",
        "image": "http://ingini.org/content/images/2014/Jun/wolf_small.jpg",
        "url": "http://ingini.org/author/ivan-hristov",
        "sameAs": "http://ingini.org",
        "description": null
    },
    "headline": "Chatting Through JActor",
    "url": "http://ingini.org/2012/11/11/chatting-through-jactor/",
    "datePublished": "2012-11-11T13:13:00.000Z",
    "dateModified": "2014-05-28T14:00:13.223Z",
    "keywords": "Java, Actor Model, Concurrency",
    "description": "Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not..."
}
    </script>

    <meta name="generator" content="Ghost 0.6" />
    <link rel="alternate" type="application/rss+xml" title="Ingini" href="http://ingini.org/rss/" />
</head>
<body class="post-template tag-java tag-actor-model tag-concurrency blogcover">

	<header class="title">
		<a href="http://ingini.org"><i class="fa fa-bookmark-o fa-lg"></i><span>Ingini</span></a>
	</header>

	<nav class="mainnav post tag-java tag-actor-model tag-concurrency">
		
	</nav>

	

<div class="index">
	<div class="wrapper">
		<h1 class="right">Chatting Through JActor</h1>
		<h2 class="left">Introduction</h2>
	</div>
</div>

<div class="profile post tag-java tag-actor-model tag-concurrency">
	<img src="../../../../content/images/2014/Jun/wolf_small.jpg" class="profileimage" alt="user">
	<h4>Ivan Hristov</h4>
	
        <ul class="socialside">
            <li><a href="https://twitter.com/iv_hristov" class="smallsocialbutton twitter" target="_blank"><i class="fa fa-twitter"></i></a></li>
            <!--<li><a href="http://facebook.com" class="smallsocialbutton facebook" target="_blank"><i class="fa fa-facebook"></i></a></li>-->
            <li><a href="https://github.com/ihr" class="smallsocialbutton github" target="_blank"><i class="fa fa-github"></i></a></li>
            <!--<li><a href="htt://instagram.com/" class="smallsocialbutton instagram" target="_blank"><i class="fa fa-instagram"></i></a></li>-->
            <li><a href="http://ingini.org/rss/" class="smallsocialbutton rss" target="_blank"><i class="fa fa-rss"></i></a></li>
        </ul>


	<p></p>
	<hr>
</div>

<div id="cover" class="cover post tag-java tag-actor-model tag-concurrency">
	<div class="background" ></div>
	<header class="wrapper">
		<h2>
				<a href="../../../../tag/java/index.html">Java</a> 
				<a href="../../../../tag/actor-model/index.html">Actor Model</a> 
				<a href="../../../../tag/concurrency/index.html">Concurrency</a> 
		</h2>
		<h1><a href="index.html#">Chatting Through JActor</a></h1>
		<span>
			Posted by <a href="../../../../author/ivan-hristov/index.html">Ivan Hristov</a>
				on <i class="fa fa-clock-o"></i> <time datetime="2012-11-11">November 11th, 2012</time>.
		</span>
	</header>
	<i class="fa fa-chevron-down movedown"></i>
</div>

<section class="posts wrapper">
	<article class="post post tag-java tag-actor-model tag-concurrency">
		<header>
			<div class="feature"><span>Featured</span><i class="fa fa-bookmark fa-lg"></i></div>
			<h2>
					<a href="../../../../tag/java/index.html">Java</a> 
					<a href="../../../../tag/actor-model/index.html">Actor Model</a> 
					<a href="../../../../tag/concurrency/index.html">Concurrency</a> 
			</h2>
			<h1 id="posttitle"><a href="index.html#">Chatting Through JActor</a></h1>
			<span>
				Posted by <a href="../../../../author/ivan-hristov/index.html">Ivan Hristov</a>
				on <i class="fa fa-clock-o"></i> <time datetime="2012-11-11">November 11th, 2012</time>.
			</span>
		</header>
		<section class="postbody">
			<p><strong>Abstract</strong> : Nearly 40 years ago <a href="https://twitter.com/CarlHewitt">Carl Hewitt</a>, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as <a href="http://www.scala-lang.org/">Scala</a>, <a href="http://www.erlang.org/">Erlang</a>, etc.) and has been implemented by several frameworks. One (of not so many) Java actor frameworks is the <a href="http://jactorconsulting.com/product/jactor/">JActor</a> framework - "a high-throughput Java Actor framework" (as described by its author <a href="https://twitter.com/laforge49">Bill la Forge</a>). In this post we are going to take a (brief) look at JActor framework by building a simple backbone for chatting (j)actors.</p>

<p><strong>Goal</strong> : Build a simple chat application using JActor framework</p>

<p><strong>Acknowledgement</strong> : My gratitude goes to the open source community and especially to:</p>

<p><a href="https://twitter.com/laforge49">Bill la Forge</a> creator of JActor framework</p>

<p><em>* Code *</em>: Project code can be found @ <a href="https://github.com/ihr/jactor-chat">GitHub</a> under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a></p>

<p>JActor is based on the idea that mailboxes should be handled by separate threads, but not the actors. This means that actors sharing common mailbox will be communicating quite fast and without the need of memory synchronisation, since everything is happening locally to the thread. This on the other hand brings us to two different basic cases: <br />
1. Actors sharing a mailbox <br />
2. Actors with different mailboxes  </p>

<p>For our chat scenario we will build two types of actors in order to capture the two basic cases. The first one (<em>ChatActor</em>) would represent the actual, physical users of our system while the second type (<em>StorageActor</em>) will represent a storage (such as a DB, File system, etc.). <em>ChatActor</em>s will exchange messages using the same mailbox (and thus the same thread) while a <em>ChatActor</em> and <em>StorageActor</em> will exchange messages using two different mailboxes (possibly two different threads).</p>

<p>NOTE: For more information about JActor, take a look at the short (20 slides) presentation written by Bill la Forge available <a href="http://jactor.sourceforge.net/slides/Actors-in-the-Small-22-feb-2012.pdf">on-line</a>. For more code samples, check: <br />
* <a href="https://github.com/anirbanbhattacharjee/jactor-in-action">JActor in action</a> <br />
* <a href="https://www.ibm.com/developerworks/mydeveloperworks/blogs/jactor/?lang=en">IBM's developerworks blog of Bill la Forge</a>  </p>

<p><em>* Maven dependencies: *</em></p>

<p>This project is build using <a href="http://maven.apache.org/">Maven</a> and several libraries, namely JActor v4.1.0, <a href="http://logback.qos.ch/">Logback</a>, Google's implementation of <a href="http://jcp.org/en/jsr/detail?id=305">JSR305</a>, Google's <a href="http://code.google.com/p/guava-libraries/">Guava</a>, <a href="http://cglib.sourceforge.net/">cglib</a> (needed by Spring), <a href="http://www.springsource.org/">Spring</a> framework, <a href="https://github.com/alexruiz/fest-assert-2.x/wiki">FEST-Assert</a>, <a href="https://github.com/alexruiz/fest-reflect">FEST-Reflect</a>, <a href="https://github.com/kentbeck/junit/wiki">JUnit</a>, and <a href="http://code.google.com/p/mockito/">Mockito</a>. The maven <em>pom.xml</em> looks as follows:</p>

{% codeblock pom.xml lang:xml %}
<?xml version="1.0" encoding="UTF-8"?>  

<p><project xmlns="http://maven.apache.org/POM/4.0.0" <br />
         xmlns:xsi="<a href='http://www.w3.org/2001/XMLSchema-instance'>http://www.w3.org/2001/XMLSchema-instance</a>"
         xsi:schemaLocation="<a href='http://maven.apache.org/POM/4.0.0'>http://maven.apache.org/POM/4.0.0</a> <a href='http://maven.apache.org/xsd/maven-4.0.0.xsd'>http://maven.apache.org/xsd/maven-4.0.0.xsd</a>">
    <modelVersion>4.0.0</modelVersion></p>

<pre><code>&lt;groupId&gt;org.ingini.jactor&lt;/groupId&gt;
&lt;artifactId&gt;jactor-chat&lt;/artifactId&gt;
&lt;version&gt;1.0&lt;/version&gt;

&lt;properties&gt;
    &lt;cglib.version&gt;2.2&lt;/cglib.version&gt;
    &lt;spring.version&gt;3.1.1.RELEASE&lt;/spring.version&gt;
    &lt;logback.version&gt;1.0.6&lt;/logback.version&gt;
    &lt;fest-reflect.version&gt;1.4&lt;/fest-reflect.version&gt;
    &lt;fest-assert.version&gt;1.4&lt;/fest-assert.version&gt;
    &lt;jactor.version&gt;4.1.0&lt;/jactor.version&gt;
    &lt;jsr305.version&gt;2.0.1&lt;/jsr305.version&gt;
    &lt;guava.version&gt;13.0.1&lt;/guava.version&gt;
    &lt;junit.version&gt;4.10&lt;/junit.version&gt;
    &lt;mockito-all.version&gt;1.9.0&lt;/mockito-all.version&gt;
&lt;/properties&gt;

&lt;dependencies&gt;

    &lt;!-- JActor framework --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.agilewiki.jactor&lt;/groupId&gt;
        &lt;artifactId&gt;jactor&lt;/artifactId&gt;
        &lt;version&gt;${jactor.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- Logging --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;version&gt;${logback.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- Tools --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.code.findbugs&lt;/groupId&gt;
        &lt;artifactId&gt;jsr305&lt;/artifactId&gt;
        &lt;version&gt;${jsr305.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
        &lt;artifactId&gt;guava&lt;/artifactId&gt;
        &lt;version&gt;${guava.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;cglib&lt;/groupId&gt;
        &lt;artifactId&gt;cglib-nodep&lt;/artifactId&gt;
        &lt;version&gt;${cglib.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- Spring dependencies --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
        &lt;version&gt;${spring.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- Test dependencies --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.easytesting&lt;/groupId&gt;
        &lt;artifactId&gt;fest-reflect&lt;/artifactId&gt;
        &lt;version&gt;${fest-reflect.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.easytesting&lt;/groupId&gt;
        &lt;artifactId&gt;fest-assert&lt;/artifactId&gt;
        &lt;version&gt;${fest-assert.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
        &lt;version&gt;${spring.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;${junit.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.mockito&lt;/groupId&gt;
        &lt;artifactId&gt;mockito-all&lt;/artifactId&gt;
        &lt;version&gt;${mockito-all.version}&lt;/version&gt;
    &lt;/dependency&gt;

&lt;/dependencies&gt;
</code></pre>

<p></project></p>

<p>{% endcodeblock %}</p>

<p><em>*Step 1: The ChatActor *</em></p>

<p>Before we define our <em>ChatActor</em> we need some identifier which will allow us to create and find an actor for a user. So we define a simple <em>UserId</em> type:</p>

<p>{% codeblock UserId.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>import com.google.common.base.Objects;</p>

<p>import javax.annotation.concurrent.Immutable;</p>

<p>@Immutable
public class UserId {</p>

<pre><code>private final long code;

public UserId(long code) {
    this.code = code;
}

public long getCode() {
    return code;
}

@Override
public int hashCode() {
    return Objects.hashCode(code);
}

@Override
public boolean equals(Object obj) {
    if(!(obj instanceof UserId)) {
        return false;
    }
    return Objects.equal(this.code, ((UserId) obj).code);
}

@Override
public String toString() {
    return String.valueOf(code);
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>Likewise, we can define a <em>MessageId</em>:</p>

<p>{% codeblock MessageId.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>import com.google.common.base.Objects;</p>

<p>import javax.annotation.concurrent.Immutable;</p>

<p>@Immutable
public class MessageId {</p>

<pre><code>private final long code;

public MessageId(long code) {
    this.code = code;
}

public long getCode() {
    return code;
}

@Override
public int hashCode() {
    return Objects.hashCode(code);
}

@Override
public boolean equals(Object obj) {
    if(!(obj instanceof MessageId)) {
        return false;
    }
    return Objects.equal(this.code, ((MessageId) obj).code);
}

@Override
public String toString() {
    return String.valueOf(code);
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>You can think of these identifiers as a type-safe, sequence based artifacts for implementing the identification aspect of our system. Once we have them, we can define a <em>ChatActor</em> type, which (as mentioned earlier) will represent an actual, physical user of our system:</p>

<p>{% codeblock ChatActor.java lang:java mark:29,36,45 %}
package org.ingini.jactor.chat.actor;</p>

<p>import com.google.common.collect.Maps; <br />
import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.RP; <br />
import org.agilewiki.jactor.lpc.JLPCActor; <br />
import org.ingini.jactor.chat.domain.*; <br />
import org.slf4j.Logger; <br />
import org.slf4j.LoggerFactory;</p>

<p>import java.util.Map; <br />
import java.util.concurrent.TimeUnit;</p>

<p>public class ChatActor extends JLPCActor {</p>

<pre><code>private final Logger logger = LoggerFactory.getLogger(this.getClass());

private final UserId id;

private final Map&lt;MessageId, ChatMsg&gt; messages = Maps.newHashMap();

private final Actor storageActor;

public ChatActor(UserId id, Actor storageActor) {
    this.id = id;
    this.storageActor = storageActor;
}

public void process(ChatMsg req) throws Exception {
    TimeUnit.SECONDS.sleep(2);
    logger.info("Actor {} received new msg ({}) from " + req.getSender(), id, req.getContent());

    messages.put(req.getId(), req);
}

public Confirmation get(MsgConfirmation req) throws Exception {
    logger.info("Confirming message {}", req.getMessageId());

    logger.info("Start sleeping");
    TimeUnit.SECONDS.sleep(2);
    logger.info("Stop sleeping");
    return messages.containsKey(req.getMessageId()) ? Confirmation.YES : Confirmation.NO;
}

public void persist(MessageId messageId) throws Exception {
    PersistChatMsg persistChatMsg = new PersistChatMsg(messages.get(messageId));
    persistChatMsg.send(this, storageActor, new RP&lt;MessageId&gt;() {
        @Override
        public void processResponse(MessageId messageId) throws Exception {
            logger.info("Removing message {}", messageId);
            messages.remove(messageId);
        }
    });
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>In the actor we have three methods which will expose three different ways of communication: <br />
1. The <em>void process(ChatMsg req)</em>  (line 29) is of the type fire-and-forget. This non-blocking behavior is tested in the <em>TestChat.testProcess()</em> method. <br />
2. The <em>Confirmation get(MsgConfirmation req)</em> (line 36) and the <em>TestChat.testGet()</em> shows how you can use a <em>JAFuture</em> instance to wait for the result of a message processing. In this example we wait for a <em>Confirmation</em> result when processing a <em>MsgConfirmation</em> message. Note that there is a second, type-safe way of getting the result by invoking <em>MsgConfirmation.send(future, actor)</em>, this can be seen in the <em>TestChat.testPersist()</em>. <br />
3. The <em>void persist(MessageId messageId)</em> (line 45) shows a blocking communication between two actors, each one with it's own mailbox. Take a look at the <em>TestChat.testPersist()</em> for a use-case scenario.</p>

<p>Quick side-note: In the course of this post you will see several places with <em>TimeUnit.SECONDS.sleep(</em><em>*);</em>. The purposes of this is to make the blocking or non-blocking behavior more evident.</p>

<p><em>*Step 2: Fixing the messages *</em></p>

<p>Our model representation of the chat data (that is going to be exchanged between the chat actors) is encapsulated in a <em>ChatMsg</em> type:</p>

<p>{% codeblock ChatMsg.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.RP; <br />
import org.agilewiki.jactor.lpc.JLPCActor; <br />
import org.agilewiki.jactor.lpc.Request; <br />
import org.ingini.jactor.chat.actor.ChatActor;</p>

<p>import javax.annotation.concurrent.Immutable;</p>

<p>@Immutable
public class ChatMsg extends Request<Void, ChatActor> {</p>

<pre><code>private final MessageId id;
private final UserId sender;
private final String content;

public ChatMsg(MessageId id, UserId sender, String content) {
    this.id = id;
    this.sender = sender;
    this.content = content;
}

@Override
public boolean isTargetType(Actor targetActor) {
    return targetActor instanceof ChatActor;
}

@Override
public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
   ((ChatActor) targetActor).process(this);

    //Finished processing msg
    rp.processResponse(null);
}

public MessageId getId() {
    return id;
}

public String getContent() {
    return content;
}

public UserId getSender() {
    return sender;
}

@Override
public String toString() {
    return "ChatMsg{" +
            "sender=" + sender +
            ", content='" + content + '\'' +
            '}';
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>For our example we also need a <em>MsgConfirmation</em> type which we use to confirm the presents of a message in a <em>ChatActor</em>'s <em>messages</em> map (see <em>ChatActor.java</em>, line 20):</p>

<p>{% codeblock MsgConfirmation.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.RP; <br />
import org.agilewiki.jactor.lpc.JLPCActor; <br />
import org.agilewiki.jactor.lpc.Request; <br />
import org.ingini.jactor.chat.actor.ChatActor;</p>

<p>import javax.annotation.concurrent.Immutable;</p>

<p>@Immutable
public class MsgConfirmation extends Request<Confirmation, ChatActor> {</p>

<pre><code>private final MessageId messageId;

public MsgConfirmation(MessageId messageId) {
    this.messageId = messageId;
}

public MessageId getMessageId() {
    return messageId;
}

@Override
public boolean isTargetType(Actor targetActor) {
    return targetActor instanceof ChatActor;
}

@Override
public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
    ChatActor chatActor = (ChatActor) targetActor;
    rp.processResponse(chatActor.get(this));
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>The <em>Confirmation</em> is a simple enum: <br />
{% codeblock MsgConfirmation.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>public enum Confirmation { <br />
    YES, NO
}
{% endcodeblock %}</p>

<p>We need one more message type in order to support the communication between a <em>ChatActor</em> and a <em>StorageActor</em>. This is the <em>PersistChatMsg</em> message: <br />
{% codeblock PersistChatMsg.java lang:java %}
package org.ingini.jactor.chat.domain;</p>

<p>import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.RP; <br />
import org.agilewiki.jactor.lpc.JLPCActor; <br />
import org.agilewiki.jactor.lpc.Request; <br />
import org.ingini.jactor.chat.actor.StorageActor;</p>

<p>import javax.annotation.concurrent.Immutable;</p>

<p>@Immutable
public class PersistChatMsg extends Request<MessageId, StorageActor> {</p>

<pre><code>private final ChatMsg message;
public PersistChatMsg(ChatMsg message) {
    this.message = message;
}

@Override
public boolean isTargetType(Actor targetActor) {
    return targetActor instanceof StorageActor;
}

@Override
public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
   ((StorageActor) targetActor).process(this, rp);
}

public ChatMsg getMessage() {
    return message;
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p><strong>Step 3: StorageActor</strong></p>

<p>We can't do without our <em>StorageActor</em>, defined as follows:</p>

<p>{% codeblock StorageActor.java lang:java %}
package org.ingini.jactor.chat.actor;</p>

<p>import org.agilewiki.jactor.RP; <br />
import org.agilewiki.jactor.lpc.JLPCActor; <br />
import org.ingini.jactor.chat.domain.PersistChatMsg; <br />
import org.slf4j.Logger; <br />
import org.slf4j.LoggerFactory;</p>

<p>import java.util.concurrent.TimeUnit;</p>

<p>public class StorageActor extends JLPCActor {</p>

<pre><code>private final Logger logger = LoggerFactory.getLogger(this.getClass());

public void process(PersistChatMsg persistChatMsg, RP rp) throws Exception {
    TimeUnit.SECONDS.sleep(3);
    logger.info("Message persisted!");
    rp.processResponse(persistChatMsg.getMessage().getId());
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p><strong>Step 4: Gluing everything together</strong></p>

<p>Now that we have all pieces of the puzzle, we can start putting them in the right places. For this purpose, we need a Spring Java-based configuration class:</p>

<p>{% codeblock JActorConfig.java lang:java %}
package org.ingini.jactor.chat.conf;</p>

<p>import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.JAMailboxFactory; <br />
import org.agilewiki.jactor.Mailbox; <br />
import org.agilewiki.jactor.MailboxFactory; <br />
import org.ingini.jactor.chat.actor.StorageActor; <br />
import org.springframework.beans.factory.annotation.Autowired; <br />
import org.springframework.context.annotation.Bean; <br />
import org.springframework.context.annotation.ComponentScan; <br />
import org.springframework.context.annotation.Configuration;</p>

<p>@Configuration
@ComponentScan({"org.ingini.jactor.chat.conf", "org.ingini.jactor.chat.service", "org.ingini.jactor.chat.actor", "org.ingini.jactor.chat.domain" })
public class JActorConfig {</p>

<pre><code>@Autowired
private MailboxFactory messageMailboxFactory;

@Bean
public MailboxFactory getMessagesMailboxFactory() {
    double blockingCoefficient = 0.2D; // Almost non-blocking Chat processing logic
    return JAMailboxFactory.newMailboxFactory(
            Math.round((float) (Runtime.getRuntime().availableProcessors() / (1 - blockingCoefficient))));
}

@Bean
public Mailbox chatMailbox() {
    return messageMailboxFactory.createMailbox();
}

@Bean
public Actor storageActor() throws Exception {
    StorageActor storageActor = new StorageActor();
    storageActor.initialize(messageMailboxFactory.createMailbox());
    return storageActor;
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>... and a service for creating and finding <em>ChatActor</em>s:</p>

<p>{% codeblock JActorService.java lang:java %}
package org.ingini.jactor.chat.service;</p>

<p>import com.google.common.base.Objects; <br />
import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.Mailbox; <br />
import org.ingini.jactor.chat.actor.ChatActor; <br />
import org.ingini.jactor.chat.domain.UserId; <br />
import org.slf4j.Logger; <br />
import org.slf4j.LoggerFactory; <br />
import org.springframework.beans.factory.annotation.Autowired; <br />
import org.springframework.stereotype.Service;</p>

<p>import javax.annotation.concurrent.ThreadSafe; <br />
import java.util.concurrent.ConcurrentHashMap; <br />
import java.util.concurrent.ConcurrentMap;</p>

<p>@Service
@ThreadSafe
public class JActorService { <br />
    private final Logger logger = LoggerFactory.getLogger(this.getClass());</p>

<pre><code>private final ConcurrentMap&lt;UserId, ChatActor&gt; actorMap = new ConcurrentHashMap&lt;UserId, ChatActor&gt;();

@Autowired
private Mailbox chatMailbox;

@Autowired
private Actor storageActor;

public ChatActor findOrInit(UserId id) {

    ChatActor clientActor;
    if (!actorMap.containsKey(id)) {
        clientActor = new ChatActor(id, storageActor);

        try {
            clientActor.initialize(chatMailbox);
        } catch (Exception e) {
            logger.error("Problem while initializing actor {}", id, e);
            throw new IllegalStateException(e);
        }
        return Objects.firstNonNull(actorMap.putIfAbsent(id, clientActor), clientActor);
    }

    return actorMap.get(id);
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p><strong>Step 5: Testing</strong></p>

<p>Finally, here is our test case:</p>

<p>{% codeblock TestChat.java lang:java %}
package org.ingini.jactor.chat;</p>

<p>import org.agilewiki.jactor.Actor; <br />
import org.agilewiki.jactor.JAFuture; <br />
import org.fest.reflect.core.Reflection; <br />
import org.ingini.jactor.chat.actor.ChatActor; <br />
import org.ingini.jactor.chat.conf.JActorConfig; <br />
import org.ingini.jactor.chat.domain.*; <br />
import org.ingini.jactor.chat.service.JActorService; <br />
import org.junit.Test; <br />
import org.junit.runner.RunWith; <br />
import org.slf4j.Logger; <br />
import org.springframework.beans.factory.annotation.Autowired; <br />
import org.springframework.test.context.ContextConfiguration; <br />
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</p>

<p>import static org.fest.assertions.Assertions.assertThat; <br />
import static org.mockito.Matchers.eq; <br />
import static org.mockito.Mockito.*;</p>

<p>@ContextConfiguration(classes = {JActorConfig.class})
@RunWith(SpringJUnit4ClassRunner.class)
public class TestChat {</p>

<pre><code>@Autowired
private JActorService jActorService;

@Test
public void testProcess() throws Exception {
    //GIVEN
    UserId jactor101Id = new UserId(101);
    ChatActor jactor101 = jActorService.findOrInit(jactor101Id);
    UserId jactor201Id = new UserId(201);
    ChatActor jactor201 = jActorService.findOrInit(jactor201Id);

    Logger logger101Mock = mock(Logger.class);
    Reflection.field("logger").ofType(Logger.class).in(jactor101).set(logger101Mock);
    Logger logger201Mock = mock(Logger.class);
    Reflection.field("logger").ofType(Logger.class).in(jactor201).set(logger201Mock);

    //WHEN
    ChatMsg chatMsg201 = new ChatMsg(new MessageId(1), jactor201Id, "Hi, I'm 201!");
    chatMsg201.sendEvent(jactor101);

    ChatMsg chatMsg101 = new ChatMsg(new MessageId(2), jactor101Id, "Hi, I'm 101!");
    chatMsg101.sendEvent(jactor201);

    //THEN
    verify(logger101Mock, never()).info(eq("Actor {} received new msg ({}) from 201"), eq(jactor101Id), eq(chatMsg201.getContent()));
    verify(logger201Mock, never()).info(eq("Actor {} received new msg ({}) from 101"), eq(jactor201Id), eq(chatMsg101.getContent()));
    verify(logger101Mock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from 201"), eq(jactor101Id), eq(chatMsg201.getContent()));
    verify(logger201Mock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from 101"), eq(jactor201Id), eq(chatMsg101.getContent()));
}

@Test
public void testGet() throws Exception {
    //GIVEN
    MsgConfirmation confirmationChatMsg = new MsgConfirmation(new MessageId(1));
    UserId jactorId = new UserId(401);
    Actor jactor = jActorService.findOrInit(jactorId);

    Logger logger101Mock = mock(Logger.class);
    Reflection.field("logger").ofType(Logger.class).in(jactor).set(logger101Mock);

    //WHEN
    JAFuture future = new JAFuture();
    Object result = future.send(jactor, confirmationChatMsg);

    //THEN
    assertThat(result).isEqualTo(Confirmation.NO);

    verify(logger101Mock, times(1)).info(eq("Start sleeping"));
    verify(logger101Mock, times(1)).info(eq("Stop sleeping"));

}

@Test
public void testPersist() throws Exception {
    //GIVEN
    UserId jactorId = new UserId(601);
    ChatActor jactor = jActorService.findOrInit(jactorId);

    Logger loggerMock = mock(Logger.class);
    Reflection.field("logger").ofType(Logger.class).in(jactor).set(loggerMock);

    MessageId messageId = new MessageId(1);
    UserId sender = new UserId(701);
    ChatMsg chatMsg = new ChatMsg(messageId, sender, "Test msg");

    //WHEN
    jactor.process(chatMsg);

    //THEN
    verify(loggerMock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from " + sender.getCode()), eq(jactorId), eq(chatMsg.getContent()));

    //AND GIVEN
    MsgConfirmation confirmationChatMsg = new MsgConfirmation(messageId);

    //WHEN
    JAFuture future = new JAFuture();
    Confirmation confirmation = confirmationChatMsg.send(future, jactor);

    //THEN
    assertThat(confirmation).isEqualTo(Confirmation.YES);

    //AND WHEN
    jactor.persist(messageId);

    confirmation = confirmationChatMsg.send(future, jactor);

    //THEN
    assertThat(confirmation).isEqualTo(Confirmation.NO);

}
</code></pre>

<p>}
{% endcodeblock %}</p>
		</section>
		<footer>
			<ul class="share left">
				<li><a href="http://twitter.com/share?text=Chatting%20Through%20JActor&url=http://ingini.org/2012/11/11/chatting-through-jactor/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" class="smallbutton lightgray"><i class="fa fa-twitter"></i>Twitter</a></li>
				<li><a href="https://www.facebook.com/sharer/sharer.php?u=http://ingini.org/2012/11/11/chatting-through-jactor/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" class="smallbutton lightgray"><i class="fa fa-facebook"></i>Facebook</a></li>
			</ul>
			<ul class="tags right">
				<a href="../../../../tag/java/index.html" class="smallbutton solidgray">Java</a>
				<a href="../../../../tag/actor-model/index.html" class="smallbutton solidgray">Actor Model</a>
				<a href="../../../../tag/concurrency/index.html" class="smallbutton solidgray">Concurrency</a>
			</ul>
		</footer>
		<div class="postprofile">
			<img src="../../../../content/images/2014/Jun/wolf_small.jpg" class="author" alt="user">
			<div class="info">
				<h4>Ivan Hristov</h4>
				<a href="http://ingini.org">http://ingini.org</a>
				<p></p>
				
        <ul class="social">
            <li><a href="https://twitter.com/iv_hristov" class="twitter" target="_blank"><i class="fa fa-twitter"></i></a></li>
            <!--<li><a href="http://facebook.com/" class="facebook" target="_blank"><i class="fa fa-facebook"></i></a></li>-->
            <li><a href="https://github.com/ihr" class="github" target="_blank"><i class="fa fa-github-alt"></i></a></li>
            <!--<li><a href="http://youtube.com/" class="youtube" target="_blank"><i class="fa fa-youtube"></i></a></li>-->
            <!--<li><a href="http://dribbble.com/" class="dribbble" target="_blank"><i class="fa fa-dribbble"></i></a></li>-->
            <li><a href="http://plus.google.com/" class="googleplus" target="_blank"><i class="fa fa-google-plus"></i></a></li>
            <!--<li><a href="http://instagram.com/" class="instagram" target="_blank"><i class="fa fa-instagram"></i></a></li>-->
            <!--<li><a href="http://pinterest.com/" class="pinterest" target="_blank"><i class="fa fa-pinterest"></i></a></li>-->
            <li><a href="http://ch.linkedin.com/in/ivhristov" class="linkedin" target="_blank"><i class="fa fa-linkedin"></i></a></li>
            <li><a href="http://ingini.org/rss/" class="rss" target="_blank"><i class="fa fa-rss"></i></a></li>
        </ul>


			</div>
		</div>
		<div class="comments">
			<a href="javascript:;" class="readmore smallbutton blue"><i class="fa fa-comments"></i>View Comments...</a>
			<div id="disqus_thread"></div>
			<div id="g-comments"></div>
		</div>

	</article>

</section>



	<footer class="wrapper">
		<div class="inlinemenu">
			<div class="graybar">
				<div class="left"><i class="fa fa-bars"></i>Navigation</div>
				<div class="right"><i class="fa fa-chevron-down"></i></div>
			</div>
			<ul class="menu">
				<a id="top"></a>
<div class="navwrap">
	<ul class="menu">
	</ul>
	<div class="toggle"><a href="index.html#"><i class="fa fa-bars"></i></a></div>
</div>			</ul>
		</div>
		<div>
			Copyright &copy; <a href="http://ingini.org/">Ingini</a>. 2015 &bull; All rights reserved.
			<span class="ghost">Proudly published with <a href="http://ghost.org" target="_blank">Ghost</a>.</span>
		</div>
	</footer>
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script async type="text/javascript" src="../../../../assets/js/theme.min.js?v=b196cc4aea"></script>

</body>
</html>
