
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Chatting Through JActor</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="../../../../assets/built/screen.css?v=1e82d01aa7">
    <link rel="stylesheet" type="text/css" href="../../../../assets/css/prism.css?v=1e82d01aa7">

    <link rel="shortcut icon" href="../../../../favicon.png" type="image/png">
    <link rel="canonical" href="http://localhost:2368/2012/11/11/chatting-through-jactor/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="http://localhost:2368/2012/11/11/chatting-through-jactor/amp/">
    
    <meta property="og:site_name" content="ingini">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Chatting Through JActor">
    <meta property="og:description" content="Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not so many) Java actor frameworks is the JActor framework -">
    <meta property="og:url" content="http://localhost:2368/2012/11/11/chatting-through-jactor/">
    <meta property="article:published_time" content="2012-11-11T13:13:00.000Z">
    <meta property="article:modified_time" content="2016-01-24T16:38:11.000Z">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Actor Model">
    <meta property="article:tag" content="Concurrency">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Chatting Through JActor">
    <meta name="twitter:description" content="Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not so many) Java actor frameworks is the JActor framework -">
    <meta name="twitter:url" content="http://localhost:2368/2012/11/11/chatting-through-jactor/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Ivan Hristov">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Java, Actor Model, Concurrency">
    <meta name="twitter:creator" content="@iv_hristov">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "ingini",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ivan Hristov",
        "image": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2018/02/ivan_hristov_small.svg",
            "width": 100,
            "height": 100
        },
        "url": "http://localhost:2368/author/ivan/",
        "sameAs": [
            "https://twitter.com/iv_hristov"
        ]
    },
    "headline": "Chatting Through JActor",
    "url": "http://localhost:2368/2012/11/11/chatting-through-jactor/",
    "datePublished": "2012-11-11T13:13:00.000Z",
    "dateModified": "2016-01-24T16:38:11.000Z",
    "keywords": "Java, Actor Model, Concurrency",
    "description": "Abstract : Nearly 40 years ago Carl Hewitt, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as Scala, Erlang, etc.) and has been implemented by several frameworks. One (of not so many) Java actor frameworks is the JActor framework -",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <script type="text/javascript" src="../../../../public/ghost-sdk.js?v=1e82d01aa7"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "83aadd2aedf2"
});
</script>
    <meta name="generator" content="Ghost 1.21">
    <link rel="alternate" type="application/rss+xml" title="ingini" href="http://localhost:2368/rss/">
    <link href="../../../../assets/css/prism.css" rel="stylesheet">
<script type="text/javascript" src="../../../../assets/js/prism.js"></script>
<script>
var ga_id = 'UA-35925613-1';
var disqus_shortname = 'ihristov'
var social_link = {
    'linkedin': 'http://ch.linkedin.com/in/ivhristov',
    'github': 'https://github.com/ihr',
    'twitter': 'https://twitter.com/iv_hristov'
}
</script>

</head>
<body class="post-template tag-java tag-actor-model tag-concurrency">

    <div class="site-wrapper">

        

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
                <a class="site-nav-logo" href="http://localhost:2368">ingini</a>
    </div>
    <div class="site-nav-right">
        <div class="social-links">
        </div>
            <a class="subscribe-button" href="index.html#subscribe">Subscribe</a>
    </div>
</nav>
    </div>
</header>


<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-java tag-actor-model tag-concurrency no-image">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="2012-11-11">11 November 2012</time>
                        <span class="date-divider">/</span> <a href="../../../../tag/java/">Java</a>
                </section>
                <h1 class="post-full-title">Chatting Through JActor</h1>
            </header>


            <section class="post-full-content">
                <div class="kg-card-markdown"><p><strong>Abstract</strong> : Nearly 40 years ago <a href="https://twitter.com/CarlHewitt">Carl Hewitt</a>, Peter Bishop and Richard Steiger introduced the actor model. Since then it has been built in some languages (such as <a href="http://www.scala-lang.org/">Scala</a>, <a href="http://www.erlang.org/">Erlang</a>, etc.) and has been implemented by several frameworks. One (of not so many) Java actor frameworks is the <a href="http://jactorconsulting.com/product/jactor/">JActor</a> framework - "a high-throughput Java Actor framework" (as described by its author <a href="https://twitter.com/laforge49">Bill la Forge</a>). In this post we are going to take a (brief) look at JActor framework by building a simple backbone for chatting (j)actors.</p>
<p><strong>Goal</strong> : Build a simple chat application using JActor framework</p>
<p><strong>Acknowledgement</strong> : My gratitude goes to the open source community and especially to:</p>
<p><a href="https://twitter.com/laforge49">Bill la Forge</a> creator of JActor framework</p>
<p>** Code **: Project code can be found @ <a href="https://github.com/ihr/jactor-chat">GitHub</a> under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a></p>
<p>JActor is based on the idea that mailboxes should be handled by separate threads, but not the actors. This means that actors sharing common mailbox will be communicating quite fast and without the need of memory synchronisation, since everything is happening locally to the thread. This on the other hand brings us to two different basic cases:</p>
<ol>
<li>Actors sharing a mailbox</li>
<li>Actors with different mailboxes</li>
</ol>
<p>For our chat scenario we will build two types of actors in order to capture the two basic cases. The first one (<em>ChatActor</em>) would represent the actual, physical users of our system while the second type (<em>StorageActor</em>) will represent a storage (such as a DB, File system, etc.). <em>ChatActor</em>s will exchange messages using the same mailbox (and thus the same thread) while a <em>ChatActor</em> and <em>StorageActor</em> will exchange messages using two different mailboxes (possibly two different threads).</p>
<p>NOTE: For more information about JActor, take a look at the short (20 slides) presentation written by Bill la Forge available <a href="http://jactor.sourceforge.net/slides/Actors-in-the-Small-22-feb-2012.pdf">on-line</a>. For more code samples, check:</p>
<ul>
<li><a href="https://github.com/anirbanbhattacharjee/jactor-in-action">JActor in action</a></li>
<li><a href="https://www.ibm.com/developerworks/mydeveloperworks/blogs/jactor/?lang=en">IBM's developerworks blog of Bill la Forge</a></li>
</ul>
<p>** Maven dependencies: **</p>
<p>This project is build using <a href="http://maven.apache.org/">Maven</a> and several libraries, namely JActor v4.1.0, <a href="http://logback.qos.ch/">Logback</a>, Google's implementation of <a href="http://jcp.org/en/jsr/detail?id=305">JSR305</a>, Google's <a href="http://code.google.com/p/guava-libraries/">Guava</a>, <a href="http://cglib.sourceforge.net/">cglib</a> (needed by Spring), <a href="http://www.springsource.org/">Spring</a> framework, <a href="https://github.com/alexruiz/fest-assert-2.x/wiki">FEST-Assert</a>, <a href="https://github.com/alexruiz/fest-reflect">FEST-Reflect</a>, <a href="https://github.com/kentbeck/junit/wiki">JUnit</a>, and <a href="http://code.google.com/p/mockito/">Mockito</a>. The maven <em>pom.xml</em> looks as follows:</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.ingini.jactor&lt;/groupId&gt;
    &lt;artifactId&gt;jactor-chat&lt;/artifactId&gt;
    &lt;version&gt;1.0&lt;/version&gt;

    &lt;properties&gt;
        &lt;cglib.version&gt;2.2&lt;/cglib.version&gt;
        &lt;spring.version&gt;3.1.1.RELEASE&lt;/spring.version&gt;
        &lt;logback.version&gt;1.0.6&lt;/logback.version&gt;
        &lt;fest-reflect.version&gt;1.4&lt;/fest-reflect.version&gt;
        &lt;fest-assert.version&gt;1.4&lt;/fest-assert.version&gt;
        &lt;jactor.version&gt;4.1.0&lt;/jactor.version&gt;
        &lt;jsr305.version&gt;2.0.1&lt;/jsr305.version&gt;
        &lt;guava.version&gt;13.0.1&lt;/guava.version&gt;
        &lt;junit.version&gt;4.10&lt;/junit.version&gt;
        &lt;mockito-all.version&gt;1.9.0&lt;/mockito-all.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;

        &lt;!-- JActor framework --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.agilewiki.jactor&lt;/groupId&gt;
            &lt;artifactId&gt;jactor&lt;/artifactId&gt;
            &lt;version&gt;${jactor.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Logging --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
            &lt;version&gt;${logback.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Tools --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.code.findbugs&lt;/groupId&gt;
            &lt;artifactId&gt;jsr305&lt;/artifactId&gt;
            &lt;version&gt;${jsr305.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
            &lt;artifactId&gt;guava&lt;/artifactId&gt;
            &lt;version&gt;${guava.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;cglib&lt;/groupId&gt;
            &lt;artifactId&gt;cglib-nodep&lt;/artifactId&gt;
            &lt;version&gt;${cglib.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring dependencies --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Test dependencies --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.easytesting&lt;/groupId&gt;
            &lt;artifactId&gt;fest-reflect&lt;/artifactId&gt;
            &lt;version&gt;${fest-reflect.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.easytesting&lt;/groupId&gt;
            &lt;artifactId&gt;fest-assert&lt;/artifactId&gt;
            &lt;version&gt;${fest-assert.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;version&gt;${junit.version}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.mockito&lt;/groupId&gt;
            &lt;artifactId&gt;mockito-all&lt;/artifactId&gt;
            &lt;version&gt;${mockito-all.version}&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

&lt;/project&gt;

</code></pre>
<p>**Step 1: The ChatActor **</p>
<p>Before we define our <em>ChatActor</em> we need some identifier which will allow us to create and find an actor for a user. So we define a simple <em>UserId</em> type:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

import com.google.common.base.Objects;

import javax.annotation.concurrent.Immutable;

@Immutable
public class UserId {

    private final long code;

    public UserId(long code) {
        this.code = code;
    }

    public long getCode() {
        return code;
    }

    @Override
    public int hashCode() {
        return Objects.hashCode(code);
    }

    @Override
    public boolean equals(Object obj) {
        if(!(obj instanceof UserId)) {
            return false;
        }
        return Objects.equal(this.code, ((UserId) obj).code);
    }

    @Override
    public String toString() {
        return String.valueOf(code);
    }
}
</code></pre>
<p>Likewise, we can define a <em>MessageId</em>:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

import com.google.common.base.Objects;

import javax.annotation.concurrent.Immutable;

@Immutable
public class MessageId {

    private final long code;

    public MessageId(long code) {
        this.code = code;
    }

    public long getCode() {
        return code;
    }

    @Override
    public int hashCode() {
        return Objects.hashCode(code);
    }

    @Override
    public boolean equals(Object obj) {
        if(!(obj instanceof MessageId)) {
            return false;
        }
        return Objects.equal(this.code, ((MessageId) obj).code);
    }

    @Override
    public String toString() {
        return String.valueOf(code);
    }
}
</code></pre>
<p>You can think of these identifiers as a type-safe, sequence based artifacts for implementing the identification aspect of our system. Once we have them, we can define a <em>ChatActor</em> type, which (as mentioned earlier) will represent an actual, physical user of our system:</p>
<pre class="language-java line-numbers" data-line="30,37,46">
<code class="language-java">package org.ingini.jactor.chat.actor;

import com.google.common.collect.Maps;
import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.RP;
import org.agilewiki.jactor.lpc.JLPCActor;
import org.ingini.jactor.chat.domain.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;
import java.util.concurrent.TimeUnit;

public class ChatActor extends JLPCActor {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    private final UserId id;

    private final Map<messageid chatmsg> messages = Maps.newHashMap();

    private final Actor storageActor;

    public ChatActor(UserId id, Actor storageActor) {
        this.id = id;
        this.storageActor = storageActor;
    }

    public void process(ChatMsg req) throws Exception {
        TimeUnit.SECONDS.sleep(2);
        logger.info("Actor {} received new msg ({}) from " + req.getSender(), id, req.getContent());

        messages.put(req.getId(), req);
    }

    public Confirmation get(MsgConfirmation req) throws Exception {
        logger.info("Confirming message {}", req.getMessageId());

        logger.info("Start sleeping");
        TimeUnit.SECONDS.sleep(2);
        logger.info("Stop sleeping");
        return messages.containsKey(req.getMessageId()) ? Confirmation.YES : Confirmation.NO;
    }

    public void persist(MessageId messageId) throws Exception {
        PersistChatMsg persistChatMsg = new PersistChatMsg(messages.get(messageId));
        persistChatMsg.send(this, storageActor, new RP<messageid>() {
            @Override
            public void processResponse(MessageId messageId) throws Exception {
                logger.info("Removing message {}", messageId);
                messages.remove(messageId);
            }
        });
    }
}
</messageid></messageid></code>
</pre>
<p>In the actor we have three methods which will expose three different ways of communication:</p>
<ol>
<li>The <em>void process(ChatMsg req)</em>  (line 29) is of the type fire-and-forget. This non-blocking behavior is tested in the <em>TestChat.testProcess()</em> method.</li>
<li>The <em>Confirmation get(MsgConfirmation req)</em> (line 36) and the <em>TestChat.testGet()</em> shows how you can use a <em>JAFuture</em> instance to wait for the result of a message processing. In this example we wait for a <em>Confirmation</em> result when processing a <em>MsgConfirmation</em> message. Note that there is a second, type-safe way of getting the result by invoking <em>MsgConfirmation.send(future, actor)</em>, this can be seen in the <em>TestChat.testPersist()</em>.</li>
<li>The <em>void persist(MessageId messageId)</em> (line 45) shows a blocking communication between two actors, each one with it's own mailbox. Take a look at the <em>TestChat.testPersist()</em> for a use-case scenario.</li>
</ol>
<p>Quick side-note: In the course of this post you will see several places with <em>TimeUnit.SECONDS.sleep(</em>*<em>);</em>. The purposes of this is to make the blocking or non-blocking behavior more evident.</p>
<p>**Step 2: Fixing the messages **</p>
<p>Our model representation of the chat data (that is going to be exchanged between the chat actors) is encapsulated in a <em>ChatMsg</em> type:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.RP;
import org.agilewiki.jactor.lpc.JLPCActor;
import org.agilewiki.jactor.lpc.Request;
import org.ingini.jactor.chat.actor.ChatActor;

import javax.annotation.concurrent.Immutable;

@Immutable
public class ChatMsg extends Request&lt;Void, ChatActor&gt; {

    private final MessageId id;
    private final UserId sender;
    private final String content;

    public ChatMsg(MessageId id, UserId sender, String content) {
        this.id = id;
        this.sender = sender;
        this.content = content;
    }

    @Override
    public boolean isTargetType(Actor targetActor) {
        return targetActor instanceof ChatActor;
    }

    @Override
    public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
       ((ChatActor) targetActor).process(this);

        //Finished processing msg
        rp.processResponse(null);
    }

    public MessageId getId() {
        return id;
    }

    public String getContent() {
        return content;
    }

    public UserId getSender() {
        return sender;
    }

    @Override
    public String toString() {
        return "ChatMsg{" +
                "sender=" + sender +
                ", content='" + content + '\'' +
                '}';
    }
}
</code></pre>
<p>For our example we also need a <em>MsgConfirmation</em> type which we use to confirm the presents of a message in a <em>ChatActor</em>'s <em>messages</em> map (see <em>ChatActor.java</em>, line 20):</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.RP;
import org.agilewiki.jactor.lpc.JLPCActor;
import org.agilewiki.jactor.lpc.Request;
import org.ingini.jactor.chat.actor.ChatActor;

import javax.annotation.concurrent.Immutable;

@Immutable
public class MsgConfirmation extends Request&lt;Confirmation, ChatActor&gt; {

    private final MessageId messageId;

    public MsgConfirmation(MessageId messageId) {
        this.messageId = messageId;
    }

    public MessageId getMessageId() {
        return messageId;
    }

    @Override
    public boolean isTargetType(Actor targetActor) {
        return targetActor instanceof ChatActor;
    }

    @Override
    public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
        ChatActor chatActor = (ChatActor) targetActor;
        rp.processResponse(chatActor.get(this));
    }
}
</code></pre>
<p>The <em>Confirmation</em> is a simple enum:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

public enum Confirmation {
    YES, NO
}
</code></pre>
<p>We need one more message type in order to support the communication between a <em>ChatActor</em> and a <em>StorageActor</em>. This is the <em>PersistChatMsg</em> message:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.domain;

import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.RP;
import org.agilewiki.jactor.lpc.JLPCActor;
import org.agilewiki.jactor.lpc.Request;
import org.ingini.jactor.chat.actor.StorageActor;

import javax.annotation.concurrent.Immutable;

@Immutable
public class PersistChatMsg extends Request&lt;MessageId, StorageActor&gt; {

    private final ChatMsg message;
    public PersistChatMsg(ChatMsg message) {
        this.message = message;
    }

    @Override
    public boolean isTargetType(Actor targetActor) {
        return targetActor instanceof StorageActor;
    }

    @Override
    public void processRequest(JLPCActor targetActor, RP rp) throws Exception {
       ((StorageActor) targetActor).process(this, rp);
    }

    public ChatMsg getMessage() {
        return message;
    }
}
</code></pre>
<p><strong>Step 3: StorageActor</strong></p>
<p>We can't do without our <em>StorageActor</em>, defined as follows:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.actor;

import org.agilewiki.jactor.RP;
import org.agilewiki.jactor.lpc.JLPCActor;
import org.ingini.jactor.chat.domain.PersistChatMsg;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.concurrent.TimeUnit;

public class StorageActor extends JLPCActor {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    public void process(PersistChatMsg persistChatMsg, RP rp) throws Exception {
        TimeUnit.SECONDS.sleep(3);
        logger.info("Message persisted!");
        rp.processResponse(persistChatMsg.getMessage().getId());
    }
}
</code></pre>
<p><strong>Step 4: Gluing everything together</strong></p>
<p>Now that we have all pieces of the puzzle, we can start putting them in the right places. For this purpose, we need a Spring Java-based configuration class:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.conf;

import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.JAMailboxFactory;
import org.agilewiki.jactor.Mailbox;
import org.agilewiki.jactor.MailboxFactory;
import org.ingini.jactor.chat.actor.StorageActor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

@Configuration
@ComponentScan({"org.ingini.jactor.chat.conf", "org.ingini.jactor.chat.service", "org.ingini.jactor.chat.actor", "org.ingini.jactor.chat.domain" })
public class JActorConfig {

    @Autowired
    private MailboxFactory messageMailboxFactory;

    @Bean
    public MailboxFactory getMessagesMailboxFactory() {
        double blockingCoefficient = 0.2D; // Almost non-blocking Chat processing logic
        return JAMailboxFactory.newMailboxFactory(
                Math.round((float) (Runtime.getRuntime().availableProcessors() / (1 - blockingCoefficient))));
    }

    @Bean
    public Mailbox chatMailbox() {
        return messageMailboxFactory.createMailbox();
    }

    @Bean
    public Actor storageActor() throws Exception {
        StorageActor storageActor = new StorageActor();
        storageActor.initialize(messageMailboxFactory.createMailbox());
        return storageActor;
    }
}
</code></pre>
<p>... and a service for creating and finding <em>ChatActor</em>s:</p>
<pre><code class="language-java">package org.ingini.jactor.chat.service;

import com.google.common.base.Objects;
import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.Mailbox;
import org.ingini.jactor.chat.actor.ChatActor;
import org.ingini.jactor.chat.domain.UserId;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.concurrent.ThreadSafe;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

@Service
@ThreadSafe
public class JActorService {
    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    private final ConcurrentMap&lt;UserId, ChatActor&gt; actorMap = new ConcurrentHashMap&lt;UserId, ChatActor&gt;();

    @Autowired
    private Mailbox chatMailbox;

    @Autowired
    private Actor storageActor;

    public ChatActor findOrInit(UserId id) {

        ChatActor clientActor;
        if (!actorMap.containsKey(id)) {
            clientActor = new ChatActor(id, storageActor);

            try {
                clientActor.initialize(chatMailbox);
            } catch (Exception e) {
                logger.error("Problem while initializing actor {}", id, e);
                throw new IllegalStateException(e);
            }
            return Objects.firstNonNull(actorMap.putIfAbsent(id, clientActor), clientActor);
        }

        return actorMap.get(id);
    }

}
</code></pre>
<p><strong>Step 5: Testing</strong></p>
<p>Finally, here is our test case:</p>
<pre><code class="language-java">package org.ingini.jactor.chat;

import org.agilewiki.jactor.Actor;
import org.agilewiki.jactor.JAFuture;
import org.fest.reflect.core.Reflection;
import org.ingini.jactor.chat.actor.ChatActor;
import org.ingini.jactor.chat.conf.JActorConfig;
import org.ingini.jactor.chat.domain.*;
import org.ingini.jactor.chat.service.JActorService;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import static org.fest.assertions.Assertions.assertThat;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.*;

@ContextConfiguration(classes = {JActorConfig.class})
@RunWith(SpringJUnit4ClassRunner.class)
public class TestChat {

    @Autowired
    private JActorService jActorService;

    @Test
    public void testProcess() throws Exception {
        //GIVEN
        UserId jactor101Id = new UserId(101);
        ChatActor jactor101 = jActorService.findOrInit(jactor101Id);
        UserId jactor201Id = new UserId(201);
        ChatActor jactor201 = jActorService.findOrInit(jactor201Id);

        Logger logger101Mock = mock(Logger.class);
        Reflection.field("logger").ofType(Logger.class).in(jactor101).set(logger101Mock);
        Logger logger201Mock = mock(Logger.class);
        Reflection.field("logger").ofType(Logger.class).in(jactor201).set(logger201Mock);

        //WHEN
        ChatMsg chatMsg201 = new ChatMsg(new MessageId(1), jactor201Id, "Hi, I'm 201!");
        chatMsg201.sendEvent(jactor101);

        ChatMsg chatMsg101 = new ChatMsg(new MessageId(2), jactor101Id, "Hi, I'm 101!");
        chatMsg101.sendEvent(jactor201);

        //THEN
        verify(logger101Mock, never()).info(eq("Actor {} received new msg ({}) from 201"), eq(jactor101Id), eq(chatMsg201.getContent()));
        verify(logger201Mock, never()).info(eq("Actor {} received new msg ({}) from 101"), eq(jactor201Id), eq(chatMsg101.getContent()));
        verify(logger101Mock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from 201"), eq(jactor101Id), eq(chatMsg201.getContent()));
        verify(logger201Mock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from 101"), eq(jactor201Id), eq(chatMsg101.getContent()));
    }

    @Test
    public void testGet() throws Exception {
        //GIVEN
        MsgConfirmation confirmationChatMsg = new MsgConfirmation(new MessageId(1));
        UserId jactorId = new UserId(401);
        Actor jactor = jActorService.findOrInit(jactorId);

        Logger logger101Mock = mock(Logger.class);
        Reflection.field("logger").ofType(Logger.class).in(jactor).set(logger101Mock);

        //WHEN
        JAFuture future = new JAFuture();
        Object result = future.send(jactor, confirmationChatMsg);

        //THEN
        assertThat(result).isEqualTo(Confirmation.NO);

        verify(logger101Mock, times(1)).info(eq("Start sleeping"));
        verify(logger101Mock, times(1)).info(eq("Stop sleeping"));

    }

    @Test
    public void testPersist() throws Exception {
        //GIVEN
        UserId jactorId = new UserId(601);
        ChatActor jactor = jActorService.findOrInit(jactorId);

        Logger loggerMock = mock(Logger.class);
        Reflection.field("logger").ofType(Logger.class).in(jactor).set(loggerMock);

        MessageId messageId = new MessageId(1);
        UserId sender = new UserId(701);
        ChatMsg chatMsg = new ChatMsg(messageId, sender, "Test msg");

        //WHEN
        jactor.process(chatMsg);

        //THEN
        verify(loggerMock, timeout(5000).times(1)).info(eq("Actor {} received new msg ({}) from " + sender.getCode()), eq(jactorId), eq(chatMsg.getContent()));

        //AND GIVEN
        MsgConfirmation confirmationChatMsg = new MsgConfirmation(messageId);

        //WHEN
        JAFuture future = new JAFuture();
        Confirmation confirmation = confirmationChatMsg.send(future, jactor);

        //THEN
        assertThat(confirmation).isEqualTo(Confirmation.YES);

        //AND WHEN
        jactor.persist(messageId);

        confirmation = confirmationChatMsg.send(future, jactor);

        //THEN
        assertThat(confirmation).isEqualTo(Confirmation.NO);

    }
}
</code></pre>
</div>
            </section>

            <section class="subscribe-form">
                <h3 class="subscribe-form-title">Subscribe to ingini</h3>
                <p>Get the latest posts delivered right to your inbox</p>
                <form method="post" action="http://127.0.0.1:2368/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"><input class="location" type="hidden" name="location"><input class="referrer" type="hidden" name="referrer">

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email" placeholder="youremail@example.com">
    </div>
    <button class="" type="submit"><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>


            </section>

            <footer class="post-full-footer">

                <section class="author-card">
                        <img class="author-profile-image" src="../../../../content/images/2018/02/ivan_hristov_small.svg" alt="Ivan Hristov">
                    <section class="author-card-content">
                        <h4 class="author-card-name"><a href="../../../../author/ivan/">Ivan Hristov</a></h4>
                            <p>Read <a href="../../../../author/ivan/">more posts</a> by this author.</p>
                    </section>
                </section>
                <div class="post-full-footer-right">
                    <a class="author-card-button" href="../../../../author/ivan/">Read More</a>
                </div>

            </footer>

            <section class="post-full-comments">
                <div id="disqus_thread"></div>
                <script>
                    if (window.disqus_shortname) {
                        var disqus_config = function () {
                            this.page.url = 'http://localhost:2368/2012/11/11/chatting-through-jactor/';
                            this.page.identifier = 'ghost-11';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                </script>
            </section>


        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
                <article class="read-next-card" style="background-image: url(../../../../content/images/2018/02/app_dev-2.svg)">
                    <header class="read-next-card-header">
                        <small class="read-next-card-header-sitetitle">— ingini —</small>
                        <h3 class="read-next-card-header-title"><a href="../../../../tag/java/">Java</a></h3>
                    </header>
                    <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"></path></svg>
</div>
                    <div class="read-next-card-content">
                        <ul>
                            <li><a href="../../../../2015/03/26/authentication-authorization-schema-design-with-mongodb/">Authentication &amp; authorization with Spring Boot &amp; MongoDB</a></li>
                            <li><a href="../../../../2014/06/17/docker-mongodb-java-yes-it-easy/">Bringing together Docker, Grunt, Maven, EmberJS &amp; MongoDB</a></li>
                            <li><a href="../../../../2013/04/03/mongodb-with-jongo-sleeves-up/">MongoDB With Jongo - Sleeves Up!</a></li>
                        </ul>
                    </div>
                    <footer class="read-next-card-footer">
                        <a href="../../../../tag/java/">See all 8 posts →</a>
                    </footer>
                </article>

                <article class="post-card post tag-java tag-akka tag-multithreading tag-actor-model tag-concurrency no-image">
    <div class="post-card-content">
        <a class="post-card-content-link" href="../../../../2013/03/17/akka-patterns-for-those-times-when-you-have-to-block/">
            <header class="post-card-header">
                    <span class="post-card-tags">Java</span>
                <h2 class="post-card-title">AKKA Ask Pattern: For Those Times When You Have to Block</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Abstract : Since you are here, chances are, you are in one of those situations where you have to come up with a blocking solution using AKKA. Thus I’m going to skip the</p>
            </section>
        </a>
        <footer class="post-card-meta">
                <img class="author-profile-image" src="../../../../content/images/2018/02/ivan_hristov_small.svg" alt="Ivan Hristov">
            <span class="post-card-author"><a href="../../../../author/ivan/">Ivan Hristov</a></span>
        </footer>
    </div>
</article>

                <article class="post-card post tag-fest-reflect tag-java tag-akka tag-mockito tag-spring tag-awaitility tag-fest tag-fest-assert tag-multithreading no-image">
    <div class="post-card-content">
        <a class="post-card-content-link" href="../../../09/16/chasing-heisenbugs-from-akka-actor-integration-test-with-awaitility/">
            <header class="post-card-header">
                    <span class="post-card-tags">FEST-Reflect</span>
                <h2 class="post-card-title">Integration Test - AKKA Actor With Awaitility</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Abstract : Ever had an impression you're changing what you're observing by simply observing it? If you so, you may have hit a Heisenbug ([1], [2]). Well, OK, I agree that a more precise</p>
            </section>
        </a>
        <footer class="post-card-meta">
                <img class="author-profile-image" src="../../../../content/images/2018/02/ivan_hristov_small.svg" alt="Ivan Hristov">
            <span class="post-card-author"><a href="../../../../author/ivan/">Ivan Hristov</a></span>
        </footer>
    </div>
</article>

        </div>
    </div>
</aside>

<div class="floating-header">
    <div class="floating-header-logo">
        <a href="http://localhost:2368">
                <img src="../../../../content/images/2018/02/ingini_blog_icon-3.png" alt="ingini icon">
            <span>ingini</span>
        </a>
    </div>
    <span class="floating-header-divider">—</span>
    <div class="floating-header-title">Chatting Through JActor</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"></path>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Chatting%20Through%20JActor&amp;url=http://localhost:2368/2012/11/11/chatting-through-jactor/" onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"></path></svg>
        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/2012/11/11/chatting-through-jactor/" onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"></path></svg>
        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:2368">ingini</a> © 2018</section>
                <nav class="site-footer-nav">
                    <a href="http://localhost:2368">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-overlay-close" href="index.html#"></a>
        <div class="subscribe-overlay-content">
            <h1 class="subscribe-overlay-title">Subscribe to ingini</h1>
            <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
            <form method="post" action="http://127.0.0.1:2368/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"><input class="location" type="hidden" name="location"><input class="referrer" type="hidden" name="referrer">

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email" placeholder="youremail@example.com">
    </div>
    <button class="" type="submit"><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>


        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=1e82d01aa7"></script>

    <script>
        if (window.social_link) {
            var url_regexp = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/
            $.each(window.social_link, function(type, url) {
                if (typeof url === "string" && url_regexp.test(url)) {
                    $('<a>', {
                        class: 'social-link social-link-'+type,
                        href: url,
                        target: '_blank'
                    }).appendTo('.social-links');
                    var builtin_type = ['500px', 'facebook', 'flickr', 'github', 'gmail', 'googleplus', 'instagram', 'line', 'linkedin', 'messenger', 'microsoftoutlook', 'plurk', 'sinaweibo', 'skype', 'snapchat', 'stackoverflow', 'telegram', 'twitter', 'wechat', 'whatsapp'];
                    var icon_path = '/assets/icons/type.svg?v=1e82d01aa7'
                    if (builtin_type.indexOf(type) > -1) {
                        icon_path = icon_path.replace('type', type);
                    } else if (type.endsWith('-local')) {
                        icon_path = icon_path.replace('type', type.substring(0, type.length-6));
                    } else {
                        icon_path = 'https://simpleicons.org/icons/'+type+'.svg';
                    }
                    $('.social-link-'+type).load(icon_path);
                }
            });
        }
    </script>

    <script>
        if (window.ga_id) {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', window.ga_id, 'auto');
            ga('require', 'linkid', 'linkid.js');
            ga('send', 'pageview');
        }
    </script>

    <script type="text/javascript" src="../../../../assets/js/prism.js?v=1e82d01aa7"></script>


    <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>


    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

</body>
